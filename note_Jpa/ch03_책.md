### 영속성 컨텍스트

- 엔티티 매니저 1개 <-> 영속성 컨텍스트 1개



---

### 변경감지

#### 스냅샷

- 엔티티를 영속성 컨텍스트에 보관할 때, 최초 상태를 복사해서 저장해두는 것.

---

### flush()

- 영속성 컨텍스트의 내용을 데이터베이스에 동기화 하는 작업이다.

#### 영속성 컨텍스트 플러시 하는 방법

1. em.flush()

2. tx.commit()

   - 자동 flush()

3. JPQL 쿼리 실행 시

   - 자동 flush()

   - SQL로 변환되면, 데이터베이스에서 엔티티를 조회하는데 flush()가 되어있지 않으면 데이터베이스에 영속성 컨텍스트 데이터가 반영되어있지 않기 때문이다.





---

### merge()

- 준영속 -> 영속 상태
- input : 준영속 엔티티 
- return : (준영속 엔티티와 별개의, 새로운) 영속 엔티티



#### 동작

```java
// 1. merge 동작 이해하기 위해 작성한 코드
Member mergeMember = em2.merge(member);

// 2. 실제 merge 사용 시, 적절한 코드
// - 사실상 준영속 엔티티를 사용할 일이 없기 때문에, 준영속 엔티티를 참조하던 변수를 영속 엔티티를 참조하도록 변경하기 
member = em2.merge(member);
```

1. 엔티티를 조회
   1. 1차 캐시에서 조회 - 식별자 값으로
   2. 데이터베이스에서 조회
      1. 1차캐시에 저장
2. **조회한 영속 엔티티에. 준영속 엔티티의 값을 채워넣는다**
   - 메서드명 그대로, 병합하는 과정. 새로운 영속 엔티티에 준영속 엔티티를 병합하는 과정이다.
3. 새롭게 만든 영속 엔티티를 return한다.